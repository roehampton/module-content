# Software Development 2 Lab 08 -- Building the frontend with PUG templates


At lab we were able to use express to build an interface onto different selections from our database. Great! But the code is messy, with HTML (presentation code) mixed up with 'business logic'.

A more professional approach is to adopt versions of the 'model view controller' pattern where data retrieval and modelling (the model) is separate from business logic (controller), and the presentation (the view).

In this lab we refactor our code to start to conform to this design pattern.

## Preparation

1. Install the node.js Pug packages

```javascript
npm install pug
```

2. Replace line 8 in docker-compose.yml with the following so that your changes to pug template files will trigger a restart of node.

```javascript
command: supervisor -e '.' index.js
```

3. Rebuild your containers with the changes

```bash
docker-compose up --build
```

## Adding Pug to your express app 

1. Create a directory called views inside your app directory

2. Add the following lines near the top of your app.js file. This tells your app to use Pug to render output.

```javascript
// Use the Pug templating engine
app.set('view engine', 'pug');
app.set('views', './app/views');
```

## Testing PUG

1. Create a file called index.pug inside your views directory with the following content

```javascript
html 
    head    
        title Title here...
    body
       h1 Heading here...
       p first paragraph xxx

```
2.Get your root route to render this template by amending your root route as follows:

```javascript
// Create a route for root
app.get("/", function(req, res)
    res.render("index");
});
```

3. Now visit ```http://localhost:3000 ```. You should see your template rendered.  Look at the HTML generated by using the inspector in developer tools.  Can you see what is going on here?  Indentation is used to structure your HTML document and a shortened syntax for tags is uses.


## Nested templates: Making a single general layout for your app

One of the strengths of templating systems is that they allow code reuse and efficiency by being able to include on e template inside another.  Lets look at that by example.

1. Create a new file called ```layout.pug``` with the following

```javascript
html 
    head    
        title Title here...
    body 
        block content
```

2. Amend your index.pug file as follows:

```javascript
extends layout
block content
    h1 Heading here...
    p first paragraph xxx
```

3. Visit localhost:3000 as before and use the inspector to examine the generated HTML code.  Can you see what has happened here?  So now you can always include the layout.pug file and never have to worry about that outermost HTML again, and if you need to change it - you only need to change it once.

## Injecting variables into pug

The real power comes with being able to push variables from your express app into the template.  Again, lets look at a simple example.

1. Add the following to your root route in your app.js file

```javascript
// Create a route for root - /
app.get("/", function(req, res) {
    res.render("index", {'title':'My index page', 'heading':'My heading'});
});
```

2. Now add the following your index.pug file

```javascript
extends layout
block content
    h1 #{heading}
    p first paragraph xxx

```

3. Amend layout.pug file 

```javascript
html 
    head    
        title #{title}
    body 
        block content
```

3. Visit http://localhost:3000 

__What you have done here is pushed a variable named heading with a value of 'my heading', and a variable called 'title' with a value called 'My title' into the index.pug template.  You have then used these variables in the template, indicating that with the syntax ```#{....}```__

__Spend some time playing with this code  - change the variable names and the values, and add some variables etc, until you are absolutely clear on 


## Rendering rows of content (iterating) in pug

We have seen how to push single variables into pug, but often in database driven apps we need to push a number of data rows to the front end, and the number of rows will differ depending on the selection criteria for the data.

No problem - as Pug has a python-like syntax for iterating over collections that are pushed through as variables. See the following example:

1. In your app.js file, root route, add the following:

```javascript
// Create a route for root - /
app.get("/", function(req, res) {
    // Set up an array of data
    var test_data = ['one', 'two', 'three', 'four'];
    // Send the array through to the template as a variable called data
    res.render("index", {'title':'My index page', 'heading':'My heading', 'data':test_data});
});
```

Here we are creating an array of data and then pushing it into the template as one variable called data.

2. In your index.pug file put the following

```javascript
extends layout
block content
    h1 #{heading}
    p first paragraph xxx
    p now lets loop 
    each item in data  
        p #{item}
```

Check the output at ```http://localhost:3000 as usual.

Lets make sure we understand every part of the code in app.js...

  * ```res.render("index", ...)``` tells our app to render via a pug template, in this case a template called index.
  * ```res.render("index", {....})``` inside the curly braces we can put a dictionary of data to be sent through to the template
  * ```res.render("index", {'title':'My index page', 'heading':'My heading', 'data':test_data})``` The items in the dictionary can be strings, numbers or data structures.  Variables that are data structures (such as arrays) can be iterated over in the template.
  * 

## Pug template cheatsheet

#### Adding attributes

Attributes of tags go in brackets after the tag. Examples:

```javascript
a(href='//google.com') Google
input(type='text' name='entered_text')
```

#### Adding classes

Use a dot immediately after the element, and then the desired class name, eg.

```Javascript
p.first-para first paragraph xxx
```


#### Adding id's

Use a hash immediately after the element, and then the desired id name, eg.

```Javascript
h1#myHeading Users
```

#### Debugging to the console from pug templates

You can add the following to examine the variables in the console from within your template:

```javascript
- console.log(data)
```

__Exercise__ Write a static web page using Pug, inside your views folder, with your name as the heading, your address and your email where you create a class for your address and an id for your email.


## Refactoring your database driven app

##### Now you are ready to remove all of the HTML markup from your app.js file in your students, modules and programmes app.

### Worked example

Original route to list all students in a table (you should already have this code)

```javascript
// Task 2 display a formatted list of students
app.get("/all-students-formatted", function(req, res) {
    var sql = 'select * from Students';
    // As we are not inside an async function we cannot use await
    // So we use .then syntax to ensure that we wait until the 
    // promise returned by the async function is resolved before we proceed
    var output = '<table border="1px">';
    db.query(sql).then(results => {
        for (var row of results) {
            output += '<tr>';
            output += '<td>' + row.id + '</td>';
            output += '<td>' + '<a href="./single-student/' + row.id + '">' + row.name + '</a>' + '</td>';
            output += '</tr>'
        }
        output+= '</table>';
        res.send(output);
    });
});
```


#### Refactored app.js

```javascript
// Task 2 display a formatted list of students
app.get("/all-students-formatted", function(req, res) {
    var sql = 'select * from Students';
    db.query(sql).then(results => {
    	    // Send the results rows to the all-students template
    	    // The rows will be in a variable called data
        res.render('all-students', {data: results});
    });
});
```

#### New all-students pug template

(You will need to create this file and place it in the views directory)

```Javascript

extends layout
block content
    - console.log(data)
    .main-content 
    h1 All students 
    table(border=1)
        for item in data 
            tr  
                td #{item.id}
                td 
                    a(href='/student-single/' + item.id) #{item.name}



```

## Exercises

Create pug templates to move all the HTML markup out of all the functions in your app.js file ie.

  * Task 3 single student page
  * Independent task 2 display a formatted list of programmes with each linked      by ID to the single programme page
  * Independent task 3 single programme page
  * Independent task 6 single module page with programme and students for the module

## Next steps

You should now be able to see how you can break down tasks in the 'front end' and backend.

Your frontend developer can go ahead and create templates in pug using placeholder values.  Your backend developer can start setting up routes in app.js and the framework for querying the database.  Another member of the team can start to design the database, create tables and pre-fill values you can work with.

In our next lab, we will tidy up the backend code to ensure re-usability and to integrate even better with pug.  Finally we will look at how you can use html forms in pug to create new database values.